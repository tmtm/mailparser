<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Style-Type" content="text/css">
    <title>MailParser</title>
    <link rel=stylesheet type="text/css" href="tommy.css">
    <link rev=made href="mailto:tommy@tmtm.org">
  </head>

  <body>
    <h1>MailParser</h1>
    <p>
      メールメッセージを処理するための Module です。
    </p>

<!--
    <h2>ダウンロード</h2>
    <ul>
      <li><a href="mailparser-0.3.8.tar.gz">mailparser-0.3.8.tar.gz</a>
      <li><a href="mailparser-0.3.7.tar.gz">mailparser-0.3.7.tar.gz</a>
      <li><a href="mailparser-0.3.6.tar.gz">mailparser-0.3.6.tar.gz</a>
      <li><a href="mailparser-0.3.5.tar.gz">mailparser-0.3.5.tar.gz</a>
      <li><a href="mailparser-0.3.4.tar.gz">mailparser-0.3.4.tar.gz</a>
      <li><a href="mailparser-0.3.3.tar.gz">mailparser-0.3.3.tar.gz</a>
      <li><a href="mailparser-0.3.2.tar.gz">mailparser-0.3.2.tar.gz</a>
      <li><a href="mailparser-0.3.1.tar.gz">mailparser-0.3.1.tar.gz</a>
      <li><a href="mailparser-0.3.tar.gz">mailparser-0.3.tar.gz</a>
      <li><a href="mailparser-0.2.1.tar.gz">mailparser-0.2.1.tar.gz</a>
      <li><a href="mailparser-0.2.tar.gz">mailparser-0.2.tar.gz</a>
      <li><a href="mailparser-0.1.tar.gz">mailparser-0.1.tar.gz</a>
    </ul>
-->

    <h2>必要なもの</h2>
    <ul>
      <li><a href="http://www.ruby-lang.org">Ruby 1.8.4</a>
    </ul>

    <h2>ライセンス</h2>
    <p>
      このプログラムは <a href="http://www.ruby-lang.org/ja/LICENSE.txt">Ruby ライセンス</a>に従います。
    </p>

    <h2>機能</h2>
    <ul>
      <li>メールを構成する文字列を解析します。
      <li>メール構造による例外は発生しません。不正な構造のメッセージがあった場合は適当に処理します。
      <li>返される文字列の文字コードは EUC-JP または UTF-8 に自動変換することができます。
      <li>処理できる charset は ISO-2022-JP, EUC-JP, SHIFT_JIS, UTF-8, US-ASCII です。
        それ以外の charset の場合はデコードせずにそのままの文字列を返します。
    </ul>

    <h2>使用例</h2>
    <pre class="code">
require "mailparser"
File.open("/tmp/hoge.eml") do |f|
  m = MailParser.new(f)
  m.parse_message f
  m.from                 # Fromへッダのメールアドレスの配列
  m.to                   # Toへッダのメールアドレスの配列
  m.subject              # Subjectへッダの内容
  m.body                 # メール本文
  m.parts                # 添付ファイルに対応する MailParserオブジェクトの配列
  m.parts[0].filename    # 一番目の添付ファイルのファイル名
  m.parts[0].body        # 一番目の添付ファイルの内容
end
</pre>

    <h2>MailParser クラス</h2>
    <h3>クラスメソッド</h3>
    <dl>
      <dt>new(<var>source</var>, <var>options</var>={})
      <dd>
        <p>
          <var>source</var> を解析対象文字列とします。
          <var>source</var> は、IO や String のように each メソッドで１行ずつ文字列を処理できるクラスのオブジェクトです。
          <var>options</var> はオプションを指定する Hash オブジェクトです。
          次のオプションを指定することができます。
        </p>
        <table>
            <tr><th>キー<th>値
            <tr>
              <td><code>:output_charset</code>
              <td>文字コードを指定します。
                有効な値は「<code>"euc-jp"</code>」「<code>"utf-8"</code>」「<code>nil</code>」です。
                nil を指定した時はコード変換を行ないません。
                デフォルトは nil です。
            <tr>
              <td><code>:body_is_first_text</code>
              <td>true の場合、マルチパートメッセージでは body が最初のテキストパートの内容を返します。
                false の場合、マルチパートメッセージでは body は nil を返します。
            <tr>
              <td><code>:read_immediately</code>
              <td>new 時にデータをすべて読み込む(true)か、必要になった時にデータを読み込む(false)かを指定します。
                デフォルトは false です。
        </table>
    </dl>

    <h3>メソッド</h3>
    <dl>
      <dt>from
      <dd>From へッダに該当する MailParser::Mailbox オブジェクトの配列。

      <dt>to
      <dd>To へッダに該当する MailParser::Address オブジェクトの配列。

      <dt>cc
      <dd>Cc へッダに該当する MailParser::Address オブジェクトの配列。

      <dt>sender
      <dd>Sender ヘッダに該当する MailParser::Mailbox オブジェクト。

      <dt>date
      <dd>Date へッダを解析した結果の DateTime オブジェクト(Dateへッダがない場合や解析できない場合は nil)

      <dt>subject
      <dd>Subject へッダの文字列(デコード済)。
        Subject ヘッダがなければ nil。

      <dt>type
      <dd>Content-Type へッダのメインタイプ名。小文字文字列。
        Content-Type ヘッダがなければ nil。

      <dt>subtype
      <dd>Content-Type へッダのサブタイプ名。小文字文字列。
        Content-Type ヘッダがなければ nil。

      <dt>charset
      <dd>Content-Type へッダの charset パラメータの値。小文字文字列。
        Content-Type ヘッダがなければ nil。

      <dt>encoding
      <dd>Content-Transfer-Encoding へッダの値。小文字文字列。
        Content-Transfer-Encoding ヘッダがなければ nil。

      <dt>multipart?
      <dd>type が "multipart" の場合 true。そうでなければ false。

      <dt>boundary
      <dd>パートの区切り文字列。multipart? が偽なら nil。

      <dt>filename
      <dd>パートのファイル名。ファイル名がなければ nil。

      <dt>header
      <dd>"へッダ名(小文字)"=>"へッダ値(デコード済文字列)" のハッシュ。

      <dt>rawheader
      <dd>生のへッダ部文字列。

      <dt>body
      <dd>メール本文(デコード済)。
        type が "multipart", "message" の場合は、body_is_first_text の指定に従います。

      <dt>parts
      <dd>添付ファイルに相当する MailParser オブジェクトの配列。
        type が "multipart" でなければ nil。

      <dt>message
      <dd>type が "message" の場合、本文部を解析した結果の MailParser オブジェクト。
        type が "message" でなければ nil。




      <dt>b64_decode(str)
      <dd>Base64 エンコードされた文字列をデコードします。
	<pre class="code">
MailParser.b64_decode("aG9nZWhvZ2U=")
  # => "hogehoge"
</pre>

      <dt>b64_hdecode(str)
      <dd>Base64 エンコードされたへッダ文字列をデコードします。
	b64_decode と同じです。
	<pre class="code">
MailParser.b64_hdecode("aG9nZWhvZ2U=")
  # => "hogehoge"
</pre>

      <dt>qp_decode(str)
      <dd>Quoted-Printable エンコードされた文字列をデコードします。
	<pre class="code">
MailParser.qp_decode("=A4=DB=A4=B2_=A4=CF=A4=B2")'
  # => "ほげ_はげ"
</pre>

      <dt>qp_hdecode(str)
      <dd>Quoted-Printable エンコードされたへッダ文字列をデコードします。
	「_」を空白にすること以外は qp_decode と同じです。
	<pre class="code">
MailParser.qp_hdecode("=A4=DB=A4=B2_=A4=CF=A4=B2")'
  # => "ほげ はげ"
</pre>

      <dt>mdecode_token(str)
      <dd>「=?chaset?encode?xxxxxx?=」の文字列をデコードします。結果の文字コードは EUC-JP です。
	<pre class="code">
MailParser.mdecode_token("=?iso-2022-jp?b?GyRCJFUkLCRVJCwbKEI=?=")
  # => "ふがふが"
</pre>

      <dt>mime_header_decode(str)
      <dd>へッダ文字列をデコードします。結果の文字コードは EUC-JP です。
	<pre class="code">
MailParser.mime_header_decode("foo =?iso-2022-jp?b?GyRCJFUkLCRVJCwbKEI=?= bar")
  # => "foo ふがふが bar"
</pre>
      <dt>trunc_comment(str)
      <dd>コメント部を取り除いた文字列を返します。
	<pre class="code">
MailParser.trunc_comment("aaa (bbb (ccc)) ddd")
  # => "aaa  ddd"
</pre>

      <dt>split_address(str)
      <dd>へッダ文字列を「,」で分割した配列を返します。
	<pre class="code">
MailParser.split_address('aaa@example.jp, hoge &lt;bbb@example.jp&gt;, "fuga,hage" &lt;ccc@example.com&gt;')
  # => ["aaa@example.jp", "hoge &lt;bbb@example.jp&gt;", "\"fuga,hage\" &lt;ccc@example.com&gt;"]
</pre>

      <dt>get_mail_address(str)
      <dd>メールアドレスの配列を返します。
	<pre class="code">
MailParser.get_mail_address('aaa@example.jp, hoge &lt;bbb@example.jp&gt;, "fuga,hage" &lt;ccc@example.com&gt;')
  # => ["aaa@example.jp", "bbb@example.jp", "ccc@example.com"]
</pre>

      <dt>parse_content_type(str)
      <dd>Content-Type へッダ文字列を解析し、次の Hash オブジェクトを返します。
	メインタイプ,サブタイプ,パラメータ名は小文字に変換されます。
	<table>
	    <tr><th>キー<th>値
	    <tr><td>:type<td>メインタイプ
	    <tr><td>:subtype<td>サブタイプ
	    <tr><td>:parameter<td>パラメータ名と値の Hash
	</table>
	<pre class="code">
MailParser.parse_content_type("Text/Plain; CharSet=euc-jp")
  # => {:type=>"text", :subtype=>"plain", :parameter=>{"charset"=>"euc-jp"}}
</pre>

      <dt>parse_content_disposition(str)
      <dd>parse_content_type と同じ。
    </dl>

    <h2>MailParser::Address クラス</h2>

    <h2>MailParser::Mailbox クラス</h2>
    <h3>インスタンスメソッド</h3>
    <dl>
      <dt>display_name / phrase
      <dd>メールアドレスの表示名の文字列を返します。

      <dt>addr_spec
      <dd>メールアドレス(MailParser::AddrSpec)を返します。
    </dl>

    <h2>MailParser::AddrSpec クラス</h2>
    <h3>インスタンスメソッド</h3>
    <dl>
      <dt>local_part
      <dd>
      <dt>domain
      <dd>
    </dl>

    <h2>履歴</h2>
    <dl>
      <dt>0.4
      <dd>
        <ul>
          <li>イチから作りなおし。0.3.x との互換なし。
        </ul>

      <dt>0.3.8 2006-03-30
      <dd>
	<ul>
	  <li>RFC 2231 に対応。
	</ul>

      <dt>0.3.7 2006-03-11
      <dd>
	<ul>
	  <li>From, To, Cc の行末が「\」の時に無限ループしていたバグを修正。
	</ul>

      <dt>0.3.6 2005-10-14
      <dd>
	<ul>
	  <li>phrase内に「&lt;」「&gt;」「(」「)」があった時にメールアドレスの取得に失敗するバグを修正。
	  <li>「(」「)」「\(」「\)」が多く存在する行のパースに長時間かかるバグを修正。
          <li>quoted-string内の「(〜)」を除去してしまうバグを修正。
	</ul>

      <dt>0.3.5 2005-06-08
      <dd>
	<ul>
	  <li>本文がHTMLで添付ファイルがついている場合に、添付ファイルが認識されないバグを修正。
	</ul>

      <dt>0.3.4 2005-05-02
      <dd>
	<ul>
	  <li>Date へッダの日付が UNIX 時刻の範囲外の時に落ちるバグを修正。
	</ul>

      <dt>0.3.3 2005-03-31
      <dd>
	<ul>
	  <li>output_charset に nil を指定した時にコード変換しないようにした。
	</ul>

      <dt>0.3.2 2005-03-01
      <dd>
	<ul>
	  <li>From,To,Ccへッダに奇数個の「"」があると無限ループになるバグを修正。
	</ul>

      <dt>0.3.1 2005-02-21
      <dd>
	<ul>
	  <li>extract_message_type=() を追加。
	</ul>

      <dt>0.3 2005-01-28
      <dd>
	<ul>
	  <li>最初の text/* を :body にするのをやめた。
	  <li>:header を Hash に変更。
	  <li>:rawheader 追加。
	  <li>Uconv ではなく NKF を使用するようにした。
	</ul>

      <dt>0.2.1 2005-01-28
      <dd>
	<ul>
	  <li>添付ファイルの Content-Type: が multipart/* の時に処理していなかったバグを修正。
	  <li>Content-Type が message/* の時、:body が nil ではなく "" になっていたバグを修正。
	  <li>最初の行が空白で始まっていると落ちるバグを修正。
	</ul>

      <dt>0.2 2005-01-06
      <dd>
	<ul>
	  <li>UTF-8対応
	  <li>output_charset=(), text_body_only=() を追加
	  <li>Test::Unit を使用
	</ul>

      <dt>0.1 2004/11/02
      <dd>
	<ul>
	  <li>公開
	</ul>
    </dl>
    <hr>
    <address><a href="mailto:tommy@tmtm.org">とみたまさひろ</a></address>
    <p>
<!-- Created: Tue Nov  2 20:34:41 JST 2004 -->
<!-- hhmts start -->
Last modified: Tue Jan 16 00:51:57 JST 2007
<!-- hhmts end -->
    </p>
  </body>
</html>
